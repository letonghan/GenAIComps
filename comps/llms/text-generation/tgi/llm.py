# Copyright (C) 2024 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

import os
import time

from fastapi.responses import StreamingResponse
from huggingface_hub import AsyncInferenceClient
from langsmith import traceable

from comps import (
    GeneratedDoc,
    LLMParamsDoc,
    ServiceType,
    opea_microservices,
    register_microservice,
    register_statistics,
    statistics_dict,
)


prompt_2k = """
### 你将扮演一个乐于助人、尊重他人并诚实的助手，你的目标是帮助用户解答问题。有效地利用来自本地知识库的搜索结果。确保你的回答中只包含相关信息。如果你不确定问题的答案，请避免分享不准确的信息。
### 搜索结果：在遥远的东方，有一个古老而神秘的国家，这个国家有着悠久的历史和丰富的文化。这里的山川河流孕育了无数代勤劳智慧的人民，他们用自己的双手和智慧创造了辉煌的文明。在这片土地上，有着许多美丽的传说和动人的故事。相传很久以前，这里住着一个年轻的樵夫，他每天都到深山里砍柴，虽然生活艰辛，但他始终保持着乐观的态度。一天，樵夫在山中偶然发现了一棵长满奇异果实的树，他小心翼翼地摘下一个果子，尝了一口，顿时感到浑身充满了力量。从那天起，他的生活发生了巨大的变化。这个国家不仅有美丽的自然风光，还有丰富的文化遗产。古老的城市中，保存着许多历史悠久的建筑和文物，它们见证了这个国家的辉煌历史。在这里，你可以看到雄伟的宫殿、精致的园林和宏伟的庙宇，每一处都散发着浓厚的历史气息。走在古老的街道上，仿佛能够听到历史的回声，感受到古人的智慧和创造力。这个国家的人们勤劳勇敢，善良友爱。他们热爱生活，追求幸福。无论是丰收的季节，还是节日的庆典，人们总是欢聚一堂，尽情享受美好的时光。传统的节日里，人们穿上节日的盛装，载歌载舞，互相祝福，分享美食。特别是春节，这是这个国家最重要的节日，家家户户都会张灯结彩，迎接新年的到来。孩子们最喜欢这个时候，因为他们可以收到长辈们的红包，穿上新衣服，吃到各种美味的年货。这个国家还有着深厚的教育传统。古代的学者们孜孜不倦地追求知识，他们留下了许多宝贵的文献和著作，对后世产生了深远的影响。如今，这里的学校和大学依然是培养人才的摇篮，许多年轻人怀揣着梦想，努力学习，期望将来能够为国家和社会做出贡献。科学技术的飞速发展，也为这个国家带来了新的机遇和挑战。人们不断创新，追求卓越，力争在国际舞台上占据一席之地。这个国家的美食也是一大特色。无论是南方的清淡口味，还是北方的浓郁口感，都能找到独特的风味。街头巷尾的小吃摊，饭馆里的家常菜，无不让人垂涎欲滴。特别是火锅，作为这里的代表性美食，深受人们的喜爱。无论寒冬腊月，还是炎炎夏日，围坐在火锅旁，大家一起涮菜，一起聊天，其乐融融。在这个国家的广袤大地上，还有许多值得探索的地方。壮丽的高山、广袤的草原、秀美的江南水乡，每一处都让人流连忘返。探寻自然的奥秘，感受大自然的神奇，是许多人心中的梦想。无论是徒步旅行，还是自驾游，都能在这里找到属于自己的乐趣。这个国家的科技发展也令人瞩目。从古代的四大发明到现代的高科技产业，这里的科技进步始终走在世界前列。许多科技公司和研究机构在这里落户，吸引了大量的科技人才。创新和研发成为推动经济发展的重要力量。尤其是在人工智能、量子计算、生物技术等领域，这个国家取得了显著的成就，为全球科技进步贡献了自己的力量。这个国家的人民非常注重教育和文化传承。从小，孩子们就被教导要尊重知识，热爱学习。学校教育不仅关注学术成绩，还注重培养学生的综合素质和创新能力。各种文化活动和社会实践让学生们在学习的同时，了解社会，增长见识。这个国家的图书馆、博物馆和文化中心遍布各地，为人们提供了丰富的文化资源和学习机会。这个国家的艺术和文学也具有独特的魅力。古代的诗人和画家留下了许多不朽的作品，现代的艺术家们则不断探索新的表现形式和创作方法。无论是传统的书法绘画，还是现代的电影音乐，都展现出这个国家深厚的文化底蕴和创新精神。每年，这里都会举办各种艺术节和文化展览，吸引了大批艺术爱好者和游客。这个国家的体育事业也蓬勃发展。无论是传统的武术，还是现代的竞技体育，都有着广泛的群众基础。每当有大型体育赛事，人们都会热情地支持自己的运动员，为他们加油助威。这个国家的运动员们在国际比赛中屡创佳绩，为国家争光。体育不仅是强身健体的方式，也是增进友谊和团结的纽带。总之，这个古老而又充满活力的国家，正以崭新的姿态走向未来。她的人民团结一心，勇往直前，为实现梦想而努力奋斗。每一个人都是这个国家的一部分，每一个梦想都值得被尊重和珍惜。未来的路还很长，但只要大家携手并进，就一定能够迎来更加美好的明天。在这片充满希望的土地上，还有许多未被发掘的宝藏等待着人们去发现。历史的长河流淌不息，新时代的篇章也在不断书写。这个国家的人民用他们的智慧和双手，创造着一个又一个奇迹。无论是科技的突破，还是文化的传承，每一个领域都在焕发着新的活力。每一位平凡的劳动者，每一位辛勤的学者，每一位勇敢的创新者，都是这个国家走向繁荣与强大的基石。在这片土地上，人们懂得感恩与珍惜。他们感恩祖先留下的宝贵遗产，珍惜现在所拥有的一切。无论生活多么忙碌，人们总会抽出时间，陪伴家人，朋友，共同度过那些美好时光。家庭的温暖，友情的珍贵，这些都是人生中最宝贵的财富。面对未来，这个国家的人民充满信心。他们深知，只有团结一致，才能克服一切困难。无论前方的路多么崎岖，只要大家心往一处想，劲往一处使，就一定能够迎来光明的明天。每一个人的梦想，都是这个国家梦想的一部分。每一个人的努力，都是这个国家前进的动力。无论身处何地，心系祖国，这份情感，永不改变。这个国家的故事还在继续，每一天都是新的篇章。未来的道路上，充满了无限的可能。这个国家的人民，将继续用他们的智慧和努力，书写更加辉煌的历史。无论风雨，始终前行，因为他们相信，光明就在前方，梦想终会实现。在这片充满希望的土地上，还有许多未被发掘的宝藏等待着人们去发现。历史的长河流淌不息，新时代的篇章也在不断书写。这个国家的人民用他们的智慧和双手，创造着一个又一个奇迹。无论是科技的突破，还是文化的传承，每一个领域都在焕发着新的活力。每一位平凡的劳动者，每一位辛勤的学者，每一位勇敢的创新者，都是这个国家走向繁荣与强大的基石。在这片土地上，人们懂得感恩与珍惜。他们感恩祖先留下的宝贵遗产，珍惜现在所拥有的一切。无论生活多么忙碌，人们总会抽出时间，陪伴家人，朋友，共同度过那些美好时光。家庭的温暖，友情的珍贵，这些都是人生中最宝贵的财富。面对未来，这个国家的人民充满信心。他们深知，只有团结一致，才能克服一切困难。无论前方的路多么崎岖，只要大家心往一处想，劲往一处使，就一定能够迎来光明的明天。每一个人的梦想，都是这个国家梦想的一部分。每一个人的努力，都是这个国家前进的动力。无论身处何地，心系祖国，这份情感，永不改变。这个国家的故事还在继续，每一天都是新的篇章。未来的道路上，充满了无限的可能。这个国家的人民，将继续用他们的智慧和努力，书写更加辉煌的历史。无论风雨，始终前行，因为他们相信，光明就在前方，梦想终会实现。这个国家的艺术和文化也在不断发展。传统与现代在这里交融，古老的技艺与新的创意相得益彰。无论是传统的书法绘画，还是现代的电影音乐，这里都有无数的艺术瑰宝等待人们去发现和欣赏。艺术节、文化展览遍布全国，每一处都吸引着大量的游客和艺术爱好者。这里的博物馆收藏了无数珍贵的文物，展示了这个国家丰富的历史和文化。体育也是这个国家人民生活中不可或缺的一部分。每到大型体育赛事，举国上下都充满了激情和活力。运动员们用他们的拼搏精神和优异成绩，为国家赢得了无数荣誉。无论是传统的武术，还是现代的竞技体育，都有着广泛的群众基础。体育不仅是强身健体的方式，也是增进友谊和团结的纽带。这个国家的科技发展也是全球瞩目的。人工智能、量子计算、生物技术等领域，这个国家的研究机构和企业都取得了显著的成就。许多科技公司在国际上享有盛誉，吸引了大量的科技人才前来创业和工作。创新和研发成为推动经济发展的重要力量。教育也是这个国家的优先发展领域。从幼儿园到大学，教育体系不断完善，为每一个孩子提供了公平的教育机会。学校不仅关注学生的学术成绩，还注重他们的综合素质和创新能力的培养。各种课外活动和社会实践让学生们在学习的同时，了解社会，增长见识。教育的不断进步，为国家的发展提供了源源不断的人才支持。旅游业也是这个国家的重要产业。这里有壮丽的自然景观和丰富的人文景观，每年吸引着大量的游客前来观光。无论是高山、草原、湖泊，还是古城、庙宇、园林，每一处都让人流连忘返。探寻自然的奥秘，感受历史的厚重，是许多人心中的梦想。这个国家的农业也在不断现代化。通过科技的应用，农业生产效率大大提高，农民的生活水平也得到了显著改善。绿色农业和有机农业的发展，不仅保护了环境，也为人们提供了健康的食品。农村的基础设施建设也在不断推进，乡村旅游成为新的经济增长点。在这个国家的每一个角落，人们都在为美好的生活而努力奋斗。无论是城市还是乡村，每一个地方都焕发着新的生机。真棒。
### 问题：请总结这篇文章。
### 回答：
"""


@register_microservice(
    name="opea_service@llm_tgi",
    service_type=ServiceType.LLM,
    endpoint="/v1/chat/completions",
    host="0.0.0.0",
    port=9000,
)
@traceable(run_type="llm")
@register_statistics(names=["opea_service@llm_tgi"])
async def llm_generate(input: LLMParamsDoc):
    stream_gen_time = []
    start = time.time()
    if input.streaming:

        async def stream_generator():
            chat_response = ""
            text_generation = await llm.text_generation(
                prompt=prompt_2k,
                stream=input.streaming,
                max_new_tokens=input.max_new_tokens,
                repetition_penalty=input.repetition_penalty,
                temperature=input.temperature,
                top_k=input.top_k,
                top_p=input.top_p,
            )
            async for text in text_generation:
                stream_gen_time.append(time.time() - start)
                chat_response += text
                chunk_repr = repr(text.encode("utf-8"))
                print(f"[llm - chat_stream] chunk:{chunk_repr}")
                yield f"data: {chunk_repr}\n\n"
            print(f"[llm - chat_stream] stream response: {chat_response}")
            statistics_dict["opea_service@llm_tgi"].append_latency(stream_gen_time[-1], stream_gen_time[0])
            yield "data: [DONE]\n\n"

        return StreamingResponse(stream_generator(), media_type="text/event-stream")
    else:
        response = await llm.text_generation(
            prompt=input.query,
            stream=input.streaming,
            max_new_tokens=input.max_new_tokens,
            repetition_penalty=input.repetition_penalty,
            temperature=input.temperature,
            top_k=input.top_k,
            top_p=input.top_p,
        )
        statistics_dict["opea_service@llm_tgi"].append_latency(time.time() - start, None)
        return GeneratedDoc(text=response, prompt=input.query)


if __name__ == "__main__":
    llm_endpoint = os.getenv("TGI_LLM_ENDPOINT", "http://localhost:8080")
    llm = AsyncInferenceClient(
        model=llm_endpoint,
        timeout=600,
    )
    opea_microservices["opea_service@llm_tgi"].start()
