# Copyright (C) 2024 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

import os
import time

from fastapi.responses import StreamingResponse
from huggingface_hub import AsyncInferenceClient
from langsmith import traceable

from comps import (
    GeneratedDoc,
    LLMParamsDoc,
    ServiceType,
    opea_microservices,
    register_microservice,
    register_statistics,
    statistics_dict,
)


prompt_3k = """
### 你将扮演一个乐于助人、尊重他人并诚实的助手，你的目标是帮助用户解答问题。有效地利用来自本地知识库的搜索结果。确保你的回答中只包含相关信息。如果你不确定问题的答案，请避免分享不准确的信息。
### 搜索结果：在遥远的东方，有一个古老而神秘的国家，这个国家有着悠久的历史和丰富的文化。这里的山川河流孕育了无数代勤劳智慧的人民，他们用自己的双手和智慧创造了辉煌的文明。在这片土地上，有着许多美丽的传说和动人的故事。相传很久以前，这里住着一个年轻的樵夫，他每天都到深山里砍柴，虽然生活艰辛，但他始终保持着乐观的态度。一天，樵夫在山中偶然发现了一棵长满奇异果实的树，他小心翼翼地摘下一个果子，尝了一口，顿时感到浑身充满了力量。从那天起，他的生活发生了巨大的变化。这个国家不仅有美丽的自然风光，还有丰富的文化遗产。古老的城市中，保存着许多历史悠久的建筑和文物，它们见证了这个国家的辉煌历史。在这里，你可以看到雄伟的宫殿、精致的园林和宏伟的庙宇，每一处都散发着浓厚的历史气息。走在古老的街道上，仿佛能够听到历史的回声，感受到古人的智慧和创造力。这个国家的人们勤劳勇敢，善良友爱。他们热爱生活，追求幸福。无论是丰收的季节，还是节日的庆典，人们总是欢聚一堂，尽情享受美好的时光。传统的节日里，人们穿上节日的盛装，载歌载舞，互相祝福，分享美食。特别是春节，这是这个国家最重要的节日，家家户户都会张灯结彩，迎接新年的到来。孩子们最喜欢这个时候，因为他们可以收到长辈们的红包，穿上新衣服，吃到各种美味的年货。这个国家还有着深厚的教育传统。古代的学者们孜孜不倦地追求知识，他们留下了许多宝贵的文献和著作，对后世产生了深远的影响。如今，这里的学校和大学依然是培养人才的摇篮，许多年轻人怀揣着梦想，努力学习，期望将来能够为国家和社会做出贡献。科学技术的飞速发展，也为这个国家带来了新的机遇和挑战。人们不断创新，追求卓越，力争在国际舞台上占据一席之地。这个国家的美食也是一大特色。无论是南方的清淡口味，还是北方的浓郁口感，都能找到独特的风味。街头巷尾的小吃摊，饭馆里的家常菜，无不让人垂涎欲滴。特别是火锅，作为这里的代表性美食，深受人们的喜爱。无论寒冬腊月，还是炎炎夏日，围坐在火锅旁，大家一起涮菜，一起聊天，其乐融融。在这个国家的广袤大地上，还有许多值得探索的地方。壮丽的高山、广袤的草原、秀美的江南水乡，每一处都让人流连忘返。探寻自然的奥秘，感受大自然的神奇，是许多人心中的梦想。无论是徒步旅行，还是自驾游，都能在这里找到属于自己的乐趣。这个国家的科技发展也令人瞩目。从古代的四大发明到现代的高科技产业，这里的科技进步始终走在世界前列。许多科技公司和研究机构在这里落户，吸引了大量的科技人才。创新和研发成为推动经济发展的重要力量。尤其是在人工智能、量子计算、生物技术等领域，这个国家取得了显著的成就，为全球科技进步贡献了自己的力量。这个国家的人民非常注重教育和文化传承。从小，孩子们就被教导要尊重知识，热爱学习。学校教育不仅关注学术成绩，还注重培养学生的综合素质和创新能力。各种文化活动和社会实践让学生们在学习的同时，了解社会，增长见识。这个国家的图书馆、博物馆和文化中心遍布各地，为人们提供了丰富的文化资源和学习机会。这个国家的艺术和文学也具有独特的魅力。古代的诗人和画家留下了许多不朽的作品，现代的艺术家们则不断探索新的表现形式和创作方法。无论是传统的书法绘画，还是现代的电影音乐，都展现出这个国家深厚的文化底蕴和创新精神。每年，这里都会举办各种艺术节和文化展览，吸引了大批艺术爱好者和游客。这个国家的体育事业也蓬勃发展。无论是传统的武术，还是现代的竞技体育，都有着广泛的群众基础。每当有大型体育赛事，人们都会热情地支持自己的运动员，为他们加油助威。这个国家的运动员们在国际比赛中屡创佳绩，为国家争光。体育不仅是强身健体的方式，也是增进友谊和团结的纽带。总之，这个古老而又充满活力的国家，正以崭新的姿态走向未来。她的人民团结一心，勇往直前，为实现梦想而努力奋斗。每一个人都是这个国家的一部分，每一个梦想都值得被尊重和珍惜。未来的路还很长，但只要大家携手并进，就一定能够迎来更加美好的明天。在这片充满希望的土地上，还有许多未被发掘的宝藏等待着人们去发现。历史的长河流淌不息，新时代的篇章也在不断书写。这个国家的人民用他们的智慧和双手，创造着一个又一个奇迹。无论是科技的突破，还是文化的传承，每一个领域都在焕发着新的活力。每一位平凡的劳动者，每一位辛勤的学者，每一位勇敢的创新者，都是这个国家走向繁荣与强大的基石。在这片土地上，人们懂得感恩与珍惜。他们感恩祖先留下的宝贵遗产，珍惜现在所拥有的一切。无论生活多么忙碌，人们总会抽出时间，陪伴家人，朋友，共同度过那些美好时光。家庭的温暖，友情的珍贵，这些都是人生中最宝贵的财富。面对未来，这个国家的人民充满信心。他们深知，只有团结一致，才能克服一切困难。无论前方的路多么崎岖，只要大家心往一处想，劲往一处使，就一定能够迎来光明的明天。每一个人的梦想，都是这个国家梦想的一部分。每一个人的努力，都是这个国家前进的动力。无论身处何地，心系祖国，这份情感，永不改变。这个国家的故事还在继续，每一天都是新的篇章。未来的道路上，充满了无限的可能。这个国家的人民，将继续用他们的智慧和努力，书写更加辉煌的历史。无论风雨，始终前行，因为他们相信，光明就在前方，梦想终会实现。在这片充满希望的土地上，还有许多未被发掘的宝藏等待着人们去发现。历史的长河流淌不息，新时代的篇章也在不断书写。这个国家的人民用他们的智慧和双手，创造着一个又一个奇迹。无论是科技的突破，还是文化的传承，每一个领域都在焕发着新的活力。每一位平凡的劳动者，每一位辛勤的学者，每一位勇敢的创新者，都是这个国家走向繁荣与强大的基石。在这片土地上，人们懂得感恩与珍惜。他们感恩祖先留下的宝贵遗产，珍惜现在所拥有的一切。无论生活多么忙碌，人们总会抽出时间，陪伴家人，朋友，共同度过那些美好时光。家庭的温暖，友情的珍贵，这些都是人生中最宝贵的财富。面对未来，这个国家的人民充满信心。他们深知，只有团结一致，才能克服一切困难。无论前方的路多么崎岖，只要大家心往一处想，劲往一处使，就一定能够迎来光明的明天。每一个人的梦想，都是这个国家梦想的一部分。每一个人的努力，都是这个国家前进的动力。无论身处何地，心系祖国，这份情感，永不改变。这个国家的故事还在继续，每一天都是新的篇章。未来的道路上，充满了无限的可能。这个国家的人民，将继续用他们的智慧和努力，书写更加辉煌的历史。无论风雨，始终前行，因为他们相信，光明就在前方，梦想终会实现。这个国家的艺术和文化也在不断发展。传统与现代在这里交融，古老的技艺与新的创意相得益彰。无论是传统的书法绘画，还是现代的电影音乐，这里都有无数的艺术瑰宝等待人们去发现和欣赏。艺术节、文化展览遍布全国，每一处都吸引着大量的游客和艺术爱好者。这里的博物馆收藏了无数珍贵的文物，展示了这个国家丰富的历史和文化。体育也是这个国家人民生活中不可或缺的一部分。每到大型体育赛事，举国上下都充满了激情和活力。运动员们用他们的拼搏精神和优异成绩，为国家赢得了无数荣誉。无论是传统的武术，还是现代的竞技体育，都有着广泛的群众基础。体育不仅是强身健体的方式，也是增进友谊和团结的纽带。这个国家的科技发展也是全球瞩目的。人工智能、量子计算、生物技术等领域，这个国家的研究机构和企业都取得了显著的成就。许多科技公司在国际上享有盛誉，吸引了大量的科技人才前来创业和工作。创新和研发成为推动经济发展的重要力量。教育也是这个国家的优先发展领域。从幼儿园到大学，教育体系不断完善，为每一个孩子提供了公平的教育机会。学校不仅关注学生的学术成绩，还注重他们的综合素质和创新能力的培养。各种课外活动和社会实践让学生们在学习的同时，了解社会，增长见识。教育的不断进步，为国家的发展提供了源源不断的人才支持。旅游业也是这个国家的重要产业。这里有壮丽的自然景观和丰富的人文景观，每年吸引着大量的游客前来观光。无论是高山、草原、湖泊，还是古城、庙宇、园林，每一处都让人流连忘返。探寻自然的奥秘，感受历史的厚重，是许多人心中的梦想。这个国家的农业也在不断现代化。通过科技的应用，农业生产效率大大提高，农民的生活水平也得到了显著改善。绿色农业和有机农业的发展，不仅保护了环境，也为人们提供了健康的食品。农村的基础设施建设也在不断推进，乡村旅游成为新的经济增长点。在这个国家的每一个角落，人们都在为美好的生活而努力奋斗。无论是城市还是乡村，每一个地方都焕发着新的生机。政府的政策支持和人民的共同努力，让这个国家不断向前发展。未来，这个国家将继续保持开放与包容，吸引更多的人才和资源，推动经济和社会的全面进步。这个国家的历史悠久而丰富，跨越了数千年的风风雨雨。从古代的封建社会到现代的民主制度，这里的历史发展经历了许多波折和变迁。每一个历史时期都留下了深刻的印记，塑造了今天这个国家的面貌。古代的帝国、王朝和 dynasties 都在这里留下了丰 富的文化遗产，今天的人们仍然能够从这些历史遗迹中感受到当时的辉煌与荣耀。古老的皇宫、寺庙和城堡，每一处都讲述着一段段动人的历史故事。现代化进程中，这个国家也经历了巨大的变革。工业化和城市化的快速发展改变了人们的生活方式，也带来了许多新的挑战。传统的农业社会逐渐转变为现代化的工业社会，科技和经济的发展推动了社会的进步。高楼大厦、繁忙的街道和现代化的交通系统，都展示了这个国家的蓬勃发展和强大实力。在这些变化中，人们不断调整自己的生活节奏，适应新的社会环境，同时也在努力保持和传承那些宝贵的传统和文化。这个国家的社会结构也在不断演变。随着教育水平的提高和社会意识的增强，人们对平等和公正的要求越来越高。政府在推动社会进步的同时，也在不断完善法律制度和社会保障体系。平等的机会、社会福利和人权保护，成为了这个国家发展的重要方向。人们的生活质量逐渐提高，社会的整体和谐也得到了改善。各种社会活动和公益事业的兴起，让人们在追求物质财富的同时，也更加关注社会责任和人际关系的和谐。科技的飞速发展对社会各个领域产生了深远的影响。互联网的普及、智能设备的广泛应用，改变了人们的沟通方式和生活习惯。信息技术的进步推动了各行各业的变革，从医疗、教育到金融、娱乐，每个领域都在经历着数字化和智能化的浪潮。电子商务的兴起让购物变得更加方便快捷，在线教育的普及让学习变得更加灵活多样。科技的发展不仅提高了生产效率，也丰富了人们的生活方式。在国际事务中，这个国家也发挥着重要作用。作为全球经济和政治的重要一员，它在国际组织和多边合作中积极参与，推动全球治理和国际合作。无论是应对气候变化、解决国际冲突，还是促进全球贸易和经济发展，这个国家都在为全球的和平与繁荣做出贡献。它与世界各国建立了广泛的外交关系，通过合作与交流，共同应对全球性挑战。这个国家的国际形象也因其在全球事务中的积极作用而得到了提升，赢得了国际社会的尊重和认可。文化交流也是这个国家对外开放的重要组成部分。通过文化交流活动，人民能够更加深入地了解其他国家的风俗习惯和文化背景，同时也向世界展示自己独特的文化魅力。各种文化交流项目、艺术展览和国际比赛，为不同国家和地区的人民提供了交流和学习的机会。通过这些活动，这个国家的文化影响力不断扩大，国际社会对其文化的认同度也在不断提高。人们通过艺术和文化的交流，不仅加深了对其他国家文化的理解，也促进了国际间的友谊和合作。教育的全球化也在不断推进。这个国家的教育体系不仅吸引了大量的国际学生，也在积极参与全球教育合作。国际化的教育项目和跨国交流项目，让学生们能够在多元文化的环境中成长。通过与其他国家的教育机构合作，分享教育资源和教学经验，推动教育领域的共同进步。教育的全球化不仅提升了国家的教育水平，也增强了国际间的文化理解和合作。未来，这个国家将继续在教育领域发挥重要作用，为全球教育的发展做出贡献。这个国家的科技创新不仅在国内产生了深远的影响，也在全球范围内引起了广泛关注。从传统的制造业到现代的高科技产业，这个国家一直致力于推动技术进步和创新。科技园区和研究机构的建立，为科技人才提供了良好的发展平台。政府的政策支持和投资推动了科技领域的快速发展。人工智能、大数据、区块链等前沿技术在这里得到了广泛应用，推动了各个行业的变革。无论是智能家居、自动驾驶还是医疗科技，这些创新技术都在不断提升人们的生活质量和生产效率。与此同时，这个国家也在注重科技伦理和社会责任。科技的进步带来了许多机遇，但也伴随着一些挑战。数据隐私、安全问题和技术滥用等问题，引发了社会各界的广泛关注。政府和科技企业正在积极探索制定相关法规和标准，确保科技的健康发展。在推动科技创新的同时，重视科技对社会的影响，推动科技与社会的和谐发展，成为了国家发展战略的重要组成部分。在环境保护方面，这个国家也采取了积极的措施。面对全球气候变化和环境污染的问题，国家制定了一系列环境保护政策。绿色能源、可再生资源的开发利用，减少碳排放和环境污染，成为了国家发展的重要目标。各种环保项目和绿色技术的应用，有效地改善了空气和水质，保护了生态环境。公众的环保意识也在不断提高，越来越多的人参与到环保行动中，共同推动可持续发展的实现。文化创意产业也是这个国家经济的重要组成部分。影视制作、音乐、文学等领域蓬勃发展，涌现出了一大批优秀的文化作品和艺术家。国家对文化创意产业的支持力度不断加大。真棒。
### 问题：请总结这篇文章。
### 回答：
"""

@register_microservice(
    name="opea_service@llm_tgi",
    service_type=ServiceType.LLM,
    endpoint="/v1/chat/completions",
    host="0.0.0.0",
    port=9000,
)
@traceable(run_type="llm")
@register_statistics(names=["opea_service@llm_tgi"])
async def llm_generate(input: LLMParamsDoc):
    stream_gen_time = []
    start = time.time()
    if input.streaming:

        async def stream_generator():
            chat_response = ""
            text_generation = await llm.text_generation(
                prompt=prompt_3k,
                stream=input.streaming,
                max_new_tokens=input.max_new_tokens,
                repetition_penalty=input.repetition_penalty,
                temperature=input.temperature,
                top_k=input.top_k,
                top_p=input.top_p,
            )
            async for text in text_generation:
                stream_gen_time.append(time.time() - start)
                chat_response += text
                chunk_repr = repr(text.encode("utf-8"))
                print(f"[llm - chat_stream] chunk:{chunk_repr}")
                yield f"data: {chunk_repr}\n\n"
            print(f"[llm - chat_stream] stream response: {chat_response}")
            statistics_dict["opea_service@llm_tgi"].append_latency(stream_gen_time[-1], stream_gen_time[0])
            yield "data: [DONE]\n\n"

        return StreamingResponse(stream_generator(), media_type="text/event-stream")
    else:
        response = await llm.text_generation(
            prompt=input.query,
            stream=input.streaming,
            max_new_tokens=input.max_new_tokens,
            repetition_penalty=input.repetition_penalty,
            temperature=input.temperature,
            top_k=input.top_k,
            top_p=input.top_p,
        )
        statistics_dict["opea_service@llm_tgi"].append_latency(time.time() - start, None)
        return GeneratedDoc(text=response, prompt=input.query)


if __name__ == "__main__":
    llm_endpoint = os.getenv("TGI_LLM_ENDPOINT", "http://localhost:8080")
    llm = AsyncInferenceClient(
        model=llm_endpoint,
        timeout=600,
    )
    opea_microservices["opea_service@llm_tgi"].start()
